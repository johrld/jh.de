---
import Navigation from '../components/Navigation.astro';
import Footer from '../components/Footer.astro';
import { languages } from '../i18n/config';
import type { Lang } from '../i18n/config';

interface Props {
  title: string;
  description: string;
  keywords?: string[];
  image?: string;
  type?: 'article' | 'website';
  publishedTime?: Date;
  modifiedTime?: Date;
  author?: string;
  lang?: Lang;
  translations?: Partial<Record<Lang, string>>;
}

const {
  title,
  description,
  keywords = [],
  image,
  type = 'website',
  publishedTime,
  modifiedTime,
  author = 'Johannes Herold',
  lang = 'de',
  translations,
} = Astro.props;

const canonicalUrl = Astro.url.href;
const siteName = 'Johannes Herold';
const siteUrl = import.meta.env.SITE || 'https://www.jh.de';

const getPathWithoutLang = (path: string): string => {
  for (const langCode of Object.keys(languages)) {
    if (path.startsWith(`/${langCode}/`)) return path.slice(langCode.length + 1);
    if (path === `/${langCode}`) return '/';
  }
  return path;
};

const basePath = getPathWithoutLang(Astro.url.pathname);

const hreflangUrls = Object.keys(languages).map(langCode => ({
  lang: langCode,
  url: `${siteUrl}/${langCode}${basePath === '/' ? '' : basePath}`
}));
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />

    <title>{title}</title>
    <meta name="title" content={title} />
    <meta name="description" content={description} />
    {keywords.length > 0 && <meta name="keywords" content={keywords.join(', ')} />}
    {author && <meta name="author" content={author} />}
    <link rel="canonical" href={canonicalUrl} />

    {hreflangUrls.map(({ lang: hrefLang, url }) => (
      <link rel="alternate" hreflang={hrefLang} href={url} />
    ))}
    <link rel="alternate" hreflang="x-default" href={`${siteUrl}/de${basePath === '/' ? '' : basePath}`} />

    <meta property="og:type" content={type} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:site_name" content={siteName} />
    <meta property="og:locale" content={lang === 'de' ? 'de_DE' : 'en_US'} />
    {image && <meta property="og:image" content={new URL(image, Astro.site).href} />}
    {publishedTime && <meta property="article:published_time" content={publishedTime.toISOString()} />}
    {modifiedTime && <meta property="article:modified_time" content={modifiedTime.toISOString()} />}

    <meta property="twitter:card" content={image ? 'summary_large_image' : 'summary'} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />

    <meta name="robots" content="index, follow" />

    <style is:inline>
      html[data-theme="dark"] {
        --color-text: #f4f4f5;
        --color-text-secondary: #a1a1aa;
        --color-text-light: #a1a1aa;
        --color-text-muted: #71717a;
        --color-bg: #0a0a0b;
        --color-bg-subtle: #18181b;
        --color-bg-secondary: #27272a;
        --color-border: #3f3f46;
        --color-border-light: #27272a;
        --color-accent: #3b82f6;
        --color-accent-dark: #60a5fa;
        --color-accent-light: rgba(59, 130, 246, 0.12);
        color-scheme: dark;
      }
    </style>
    <script is:inline>
      (function() {
        var stored = localStorage.getItem('theme');
        if (stored === 'dark' || (!stored && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.setAttribute('data-theme', 'dark');
        }
      })();
    </script>

    <slot name="head" />
  </head>
  <body>
    <Navigation lang={lang} translations={translations} />

    <main>
      <slot />
    </main>

    <Footer lang={lang} />

  </body>
</html>

<style is:global>
  :root {
    --color-text: #18181b;
    --color-text-secondary: #52525b;
    --color-text-light: #71717a;
    --color-text-muted: #a1a1aa;
    --color-bg: #ffffff;
    --color-bg-subtle: #fafafa;
    --color-bg-secondary: #f4f4f5;
    --color-border: #e4e4e7;
    --color-border-light: #f4f4f5;
    --color-accent: #2563eb;
    --color-accent-dark: #1d4ed8;
    --color-accent-light: rgba(37, 99, 235, 0.08);

    --max-width: 800px;
    --max-width-wide: 960px;

    --space-xs: 0.5rem;
    --space-sm: 1rem;
    --space-md: 1.5rem;
    --space-lg: 2.5rem;
    --space-xl: 4rem;
    --space-2xl: 6rem;
  }

  @font-face {
    font-family: 'Satoshi';
    src: url('/fonts/Satoshi-Variable.woff2') format('woff2');
    font-weight: 300 900;
    font-display: swap;
    font-style: normal;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  html {
    font-family: 'Satoshi', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    line-height: 1.7;
    color: var(--color-text);
    font-size: 16px;
    font-weight: 450;
    -webkit-font-smoothing: antialiased;
  }

  body {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    background: var(--color-bg);
  }

  main {
    flex: 1;
    width: 100%;
    max-width: var(--max-width);
    margin: 0 auto;
    padding: var(--space-xl) var(--space-md) var(--space-2xl);
  }

  a {
    color: var(--color-accent);
    text-decoration: none;
    transition: color 0.15s ease;
  }

  a:hover {
    color: var(--color-accent-dark);
    text-decoration: underline;
    text-underline-offset: 3px;
  }

  h1, h2, h3, h4 {
    line-height: 1.25;
    font-weight: 600;
    letter-spacing: -0.025em;
    color: var(--color-text);
  }

  h1 {
    font-size: clamp(2rem, 5vw, 2.75rem);
    margin-top: 0;
    margin-bottom: var(--space-md);
    font-weight: 700;
  }

  h2 {
    font-size: clamp(1.5rem, 3vw, 1.875rem);
    margin-top: var(--space-xl);
    margin-bottom: var(--space-sm);
  }

  h3 {
    font-size: 1.25rem;
    margin-top: var(--space-lg);
    margin-bottom: var(--space-xs);
  }

  p { margin-bottom: 1.25rem; color: var(--color-text-secondary); font-size: 1.0625rem; }

  blockquote {
    border-left: 3px solid var(--color-accent);
    padding-left: var(--space-md);
    margin: var(--space-lg) 0;
    font-style: italic;
    color: var(--color-text-light);
  }

  ul, ol {
    margin-bottom: 1.25rem;
    padding-left: var(--space-md);
    color: var(--color-text-secondary);
  }

  li { margin-bottom: var(--space-xs); }

  code {
    background: var(--color-bg-secondary);
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    font-size: 0.875em;
    font-family: 'SF Mono', Monaco, monospace;
  }

  pre {
    background: var(--color-bg-secondary);
    color: var(--color-text);
    padding: 1.25rem;
    border-radius: 8px;
    overflow-x: auto;
    margin: var(--space-md) 0;
  }

  pre code { background: none; padding: 0; }

  img { max-width: 100%; height: auto; border-radius: 8px; }

  @media (max-width: 768px) {
    main { padding: var(--space-lg) var(--space-sm) var(--space-xl); }
  }

  @media (max-width: 640px) {
    html { font-size: 15px; }
  }
</style>
